name: Build, Deploy Site & Sync Resume

on:
  push:
    branches:
      - main
    paths:
      - "resume.yaml"
      - "views/**"
      - "package.json"
      - "build.js"
      - ".github/workflows/deploy.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Site (HTML + TeX)
        run: npm run build
        env:
          NODE_ENV: production
      # Result: dist/index.html and dist/prajjwal_mehta_resume.tex exist now

      # -------------------------------------------------------
      # 1. Compile LaTeX to PDF
      # -------------------------------------------------------
      - name: Compile LaTeX to PDF
        uses: xu-cheng/latex-action@v3
        with:
          root_file: prajjwal_mehta_resume.tex
          working_directory: dist
          # This creates dist/prajjwal_mehta_resume.pdf

      # -------------------------------------------------------
      # 2. Push PDF/TeX to EXTERNAL Profile Repository
      # -------------------------------------------------------
      - name: Push Resume to Profile Repo (PRAJJWALmehta/PRAJJWALmehta)
        env:
          # This loads the token you added in Step 2
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
          USER_EMAIL: "prajjwalmehta75@gmail.com"
          USER_NAME: "PRAJJWALmehta"
          TARGET_REPO: "PRAJJWALmehta/PRAJJWALmehta"
        run: |
          echo "Cloning target repository..."
          # Clone the external repo into a temporary folder 'profile-repo'
          git clone https://x-access-token:$API_TOKEN_GITHUB@github.com/$TARGET_REPO.git profile-repo

          echo "Copying resume files..."
          # Copy the NEW filenames into the cloned repo
          cp dist/prajjwal_mehta_resume.pdf profile-repo/prajjwal_mehta_resume.pdf
          cp dist/prajjwal_mehta_resume.tex profile-repo/prajjwal_mehta_resume.tex

          echo "Pushing changes..."
          cd profile-repo
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"

          # Stage the specific files
          git add prajjwal_mehta_resume.pdf prajjwal_mehta_resume.tex

          # Commit and Push (only if there are changes)
          git commit -m "Update Resume (Auto-generated from Portfolio)" || echo "No changes to resume"
          git push

      # -------------------------------------------------------
      # 3. Continue with Site Deployment
      # -------------------------------------------------------

      # We commit the PDF to the local repo too, so the "Download" button works on your site
      - name: Commit Local PDF
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“„ Auto-generated Resume PDF [skip ci]"
          file_pattern: "dist/prajjwal_mehta_resume.pdf"

      - name: Upload Build Artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dist"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
